{% extends 'base.html' %}
{% block content %}
<section class="card config-card">
  <div class="landing-head">
    <div>
      <h2>Configuracao da Partida</h2>
      <p class="muted">Bandeiras validas: <strong>{{ available_flags }}</strong> | Paises com capital: <strong>{{ available_capitals }}</strong></p>
    </div>
    <div class="landing-actions">
      <a class="btn-primary" href="{{ url_for('tictactoe') }}">Jogo da Velha</a>
      <a class="btn-primary" href="{{ url_for('checkers') }}">Damas</a>
    </div>
  </div>

  <form method="post" action="{{ url_for('start') }}" class="grid-form">
    <label>Tipo de quiz</label>
    <div class="mode-pills" id="local_quiz_type">
      <label><input type="radio" name="quiz_type" value="flag_country" checked> Bandeira -> Pais</label>
      <label><input type="radio" name="quiz_type" value="country_capital"> Pais -> Capital</label>
    </div>

    <label>Continentes (customizavel)</label>
    <div class="continent-checks span-2" id="local_continent_checks"></div>

    <label>Modo de partida</label>
    <div class="mode-pills">
      <label><input type="radio" name="mode" value="solo" checked> Solo</label>
      <label><input type="radio" name="mode" value="versus"> 1x1 local</label>
    </div>

    <label for="player1_name">Nome Jogador 1</label>
    <input id="player1_name" name="player1_name" type="text" maxlength="24" value="{{ default.player1_name }}">

    <label for="player2_name">Nome Jogador 2</label>
    <input id="player2_name" name="player2_name" type="text" maxlength="24" value="{{ default.player2_name }}">

    <label for="rounds">Rodadas</label>
    <input id="rounds" name="rounds" type="number" min="1" value="{{ default.rounds }}" required>

    <label for="points_per_hit">Pontos por acerto</label>
    <input id="points_per_hit" name="points_per_hit" type="number" min="1" value="{{ default.points_per_hit }}" required>

    <label for="max_attempts">Tentativas por questao</label>
    <input id="max_attempts" name="max_attempts" type="number" min="1" value="{{ default.max_attempts }}" required>

    <label class="span-2"><input type="checkbox" name="flash_mode"> Modo Relampago</label>

    <label for="round_time">Tempo por rodada (s)</label>
    <input id="round_time" name="round_time" type="number" min="1" value="{{ default.round_time }}" required>

    <button class="btn-primary span-2" type="submit">Comecar Agora (local)</button>
  </form>

  <hr class="section-divider">
  <h3 class="section-title">Sala Online (1x1 em dispositivos diferentes)</h3>

  <form method="post" action="{{ url_for('room_create') }}" class="grid-form" style="margin-top: 10px;">
    <label for="room_host_name">Seu nome (Jogador 1)</label>
    <input id="room_host_name" name="player1_name" type="text" maxlength="24" value="{{ default.player1_name }}">

    <label>Tipo de quiz</label>
    <div class="mode-pills" id="room_quiz_type">
      <label><input type="radio" name="quiz_type" value="flag_country" checked> Bandeira -> Pais</label>
      <label><input type="radio" name="quiz_type" value="country_capital"> Pais -> Capital</label>
    </div>

    <label>Continentes (customizavel)</label>
    <div class="continent-checks span-2" id="room_continent_checks"></div>

    <label for="room_rounds">Rodadas</label>
    <input id="room_rounds" name="rounds" type="number" min="1" value="{{ default.rounds }}" required>

    <label for="room_points">Pontos por acerto</label>
    <input id="room_points" name="points_per_hit" type="number" min="1" value="{{ default.points_per_hit }}" required>

    <label for="room_attempts">Tentativas por questao</label>
    <input id="room_attempts" name="max_attempts" type="number" min="1" value="{{ default.max_attempts }}" required>

    <label for="room_time">Tempo por rodada (s)</label>
    <input id="room_time" name="round_time" type="number" min="1" value="{{ default.round_time }}" required>

    <label class="span-2"><input type="checkbox" name="flash_mode"> Modo Relampago</label>

    <button class="btn-primary span-2" type="submit">Criar Sala Online</button>
  </form>

  <form method="post" action="{{ url_for('room_join') }}" class="grid-form" style="margin-top: 10px;">
    <label for="join_code">Codigo da sala</label>
    <input id="join_code" name="room_code" type="text" maxlength="6" placeholder="ABC123" required>

    <label for="join_name">Seu nome (Jogador 2)</label>
    <input id="join_name" name="player2_name" type="text" maxlength="24" value="{{ default.player2_name }}" required>

    <button class="btn-primary span-2" type="submit">Entrar na Sala</button>
  </form>
</section>

<script>
  (() => {
    const data = {
      flag_country: {{ continents_flag|tojson }},
      country_capital: {{ continents_capital|tojson }}
    };
    const defaultSelected = {{ default_continent_filters|tojson }};

    function selectedType(containerId) {
      const root = document.getElementById(containerId);
      const checked = root ? root.querySelector('input[type="radio"]:checked') : null;
      return checked ? checked.value : 'flag_country';
    }

    function bindAllBehavior(scopeEl) {
      const all = scopeEl.querySelector('input[value="all"]');
      const others = Array.from(scopeEl.querySelectorAll('input[name="continent_filters"]')).filter(i => i.value !== 'all');
      if (!all) return;
      all.addEventListener('change', () => {
        if (all.checked) others.forEach(i => i.checked = false);
      });
      others.forEach(i => i.addEventListener('change', () => {
        if (i.checked) all.checked = false;
        const any = others.some(x => x.checked);
        if (!any) all.checked = true;
      }));
    }

    function renderChecks(targetId, quizType, selected = null) {
      const target = document.getElementById(targetId);
      if (!target) return;
      const items = data[quizType] || data.flag_country;
      const chosen = new Set((selected && selected.length) ? selected : defaultSelected);
      target.innerHTML = '';
      items.forEach(([code, label, count]) => {
        const id = `${targetId}_${code}`;
        const chip = document.createElement('label');
        chip.className = 'check-chip';
        chip.setAttribute('for', id);
        chip.innerHTML = `<input id="${id}" type="checkbox" name="continent_filters" value="${code}"> ${label} (${count})`;
        target.appendChild(chip);
      });
      const checks = Array.from(target.querySelectorAll('input[name="continent_filters"]'));
      checks.forEach(c => c.checked = chosen.has(c.value));
      if (!checks.some(c => c.checked) && checks.find(c => c.value === 'all')) {
        checks.find(c => c.value === 'all').checked = true;
      }
      bindAllBehavior(target);
    }

    const localTypeInputs = document.querySelectorAll('#local_quiz_type input[type="radio"]');
    const roomTypeInputs = document.querySelectorAll('#room_quiz_type input[type="radio"]');

    const getLocalSelected = () => Array.from(document.querySelectorAll('#local_continent_checks input[name="continent_filters"]:checked')).map(i => i.value);
    const getRoomSelected = () => Array.from(document.querySelectorAll('#room_continent_checks input[name="continent_filters"]:checked')).map(i => i.value);

    localTypeInputs.forEach(i => i.addEventListener('change', () => {
      renderChecks('local_continent_checks', selectedType('local_quiz_type'), getLocalSelected());
    }));
    roomTypeInputs.forEach(i => i.addEventListener('change', () => {
      renderChecks('room_continent_checks', selectedType('room_quiz_type'), getRoomSelected());
    }));

    renderChecks('local_continent_checks', selectedType('local_quiz_type'));
    renderChecks('room_continent_checks', selectedType('room_quiz_type'));
  })();
</script>
{% endblock %}
